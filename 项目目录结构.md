# 项目目录结构说明

## 📁 项目根目录

```
project/
├── app/                          # 应用核心代码目录
├── data/                         # 数据存储目录
├── outputs/                      # 输出文件目录
├── resources/                    # 资源文件目录
├── settings/                     # 配置文件目录
├── temp_uploads/                 # 临时上传文件目录
├── web/                          # Web 界面目录（预留）
├── 文档/                         # 项目文档目录
├── _temp_log_refactor.py         # 临时脚本（可删除）
├── demo_data.db                  # 演示数据库
├── main.py                       # 主程序入口（旧版）
├── run_console.py                # 控制台运行入口
├── test_browser_manager.py       # 浏览器管理器测试
└── 结构.txt                      # 结构说明文本
```

---

## 📦 app/ - 应用核心代码

### 总体结构
```
app/
├── __init__.py                   # 包初始化文件
├── main.py                       # FastAPI 应用入口
├── api/                          # API 路由层
├── core/                         # 核心功能模块
├── db/                           # 数据库相关
├── models/                       # 数据模型
├── services/                     # 业务服务层
└── utils/                        # 工具函数
```

---

### 📂 app/api/ - API 路由层
```
api/
├── browsers.py                   # 浏览器管理 API
├── human.py                      # 人工接管 API
├── stats.py                      # 统计数据 API
└── tasks.py                      # 任务管理 API
```

**说明：** 提供 RESTful API 接口，供 Web 前端或外部系统调用。

---

### 📂 app/core/ - 核心功能模块
```
core/
├── __init__.py                   # 包初始化
├── browser_manager.py            # 浏览器资源管理器
├── db.py                         # 数据库连接管理
├── logger.py                     # 日志模块（TaskLogger）
├── reporter.py                   # 报表生成器（Excel）
├── scheduler.py                  # 任务调度器
├── settings.py                   # 配置管理（单例）
├── state_machine.py              # 状态机
└── task_manager.py               # 任务管理器
```

**说明：** 
- `settings.py` - 项目唯一配置入口，读取 `settings.json`
- `logger.py` - 支持结构化日志的 TaskLogger 类
- `reporter.py` - 生成 Excel 报表（生产表、销售表）
- `browser_manager.py` - 管理 Bit 浏览器窗口生命周期
- `scheduler.py` - 任务调度与并发控制

---

### 📂 app/db/ - 数据库相关
```
db/
├── crud.py                       # CRUD 操作
├── schema.sql                    # 数据库表结构
└── session.py                    # 数据库会话管理
```

**说明：** 数据库操作封装，使用 SQLite 存储任务状态和结果。

---

### 📂 app/models/ - 数据模型
```
models/
├── account.py                    # 账号模型
├── browser.py                    # 浏览器模型
└── task.py                       # 任务模型
```

**说明：** 定义数据结构和业务实体。

---

### 📂 app/services/ - 业务服务层
```
services/
├── __init__.py                   # 包初始化
├── human_service.py              # 人工接管服务
├── browser/                      # 浏览器服务
│   ├── __init__.py
│   ├── api.py                    # Bit Browser API 封装
│   ├── browser_controller.py    # 浏览器控制器
│   └── instance.py               # 浏览器实例
├── sms/                          # 短信服务
│   └── sms_client.py             # 火狐狸短信平台客户端
└── tasks/                        # 任务实现
    ├── base_task.py              # 任务基类（抽象）
    ├── base.py                   # 基础任务
    ├── fill_form.py              # 填表任务
    ├── task_1500.py              # 1500 注册任务（主要）
    ├── yyc.py                    # YYC 任务
    ├── 养号.py                   # 养号任务
    └── 探活.py                   # 探活任务
```

**说明：**
- `browser/` - 封装 Bit Browser Local API，管理浏览器窗口
- `sms/` - 封装火狐狸短信平台 API，处理验证码
- `tasks/` - 各类自动化任务实现
  - `task_1500.py` - 核心注册任务，已去除 UI 依赖，支持多线程

---

### 📂 app/utils/ - 工具函数
```
utils/
├── exceptions.py                 # 自定义异常
└── logger.py                     # 日志工具（旧版）
```

**说明：** 通用工具函数和异常定义。

---

## 📊 data/ - 数据存储目录

```
data/
├── logs/                         # 日志文件目录
│   └── task_1500_YYYYMMDD_HHMMSS.log
├── records/                      # 记录文件目录
│   ├── 生产表_1500_YYYYMMDD.xlsx
│   └── 销售表_1500_YYYYMMDD.xlsx
└── tasks.db                      # 任务数据库（SQLite）
```

**说明：**
- `logs/` - 任务执行日志，按时间戳命名
- `records/` - Excel 报表输出
- `tasks.db` - 存储任务状态、结果等

---

## 📦 resources/ - 资源文件目录

```
resources/
├── Avatar/                       # 头像图片库（约 400+ 张）
│   ├── 1528.jpg
│   ├── 1539.jpg
│   └── ...
├── images/                       # 认证图片库
│   ├── 1/                        # 健康保险证图片
│   └── 2/                        # 驾驶证图片
└── names.txt                     # 昵称库（848 个）
```

**说明：**
- `Avatar/` - 注册时上传的头像图片
- `images/1/` - 健康保险证图片（文件名包含生日：YYYY.M.D）
- `images/2/` - 驾驶证图片（文件名包含生日：YYYY.M.D）
- `names.txt` - 随机昵称列表

---

## ⚙️ settings/ - 配置文件目录

```
settings/
├── settings.json                 # 主配置文件
└── setting.py/                   # 空目录（可删除）
```

### settings.json 结构
```json
{
  "bit_browser": {
    "api_base": "http://127.0.0.1:54345",
    "default_timeout": 60
  },
  "firefox_sms": {
    "token": "your_token_here"
  },
  "paths": {
    "assets_root": "assets",
    "avatars": "assets/avatars",
    "names": "resources/names.txt",
    "images": "images",
    "logs": "data/logs",
    "records": "data/records"
  },
  "runtime": {
    "headless": false,
    "debug": true
  }
}
```

**说明：**
- 项目唯一配置文件
- 通过 `app/core/settings.py` 读取
- 包含 4 个固定顶层键：`bit_browser`, `firefox_sms`, `paths`, `runtime`

---

## 📤 outputs/ - 输出文件目录

```
outputs/
└── 员工数据报表.xlsx              # 示例输出文件
```

**说明：** 存放各类输出文件（报表、导出数据等）。

---

## 🌐 web/ - Web 界面目录（预留）

```
web/
├── static/                       # 静态资源（CSS/JS/图片）
└── templates/                    # HTML 模板
```

**说明：** 预留的 Web 前端目录，目前为空。

---

## 📁 temp_uploads/ - 临时上传目录

```
temp_uploads/
└── (临时文件)
```

**说明：** 存放任务执行过程中的临时文件（如复制的认证图片），执行完成后自动清理。

---

## 📚 文档/ - 项目文档

```
文档/
└── 架构.txt                      # 架构设计文档
```

**说明：** 项目设计文档和说明。

---

## 🔑 核心文件说明

### 根目录文件

| 文件名 | 说明 |
|--------|------|
| `run_console.py` | **控制台运行入口**，用于命令行启动任务 |
| `main.py` | 旧版主程序入口（可能已废弃） |
| `test_browser_manager.py` | 浏览器管理器测试脚本 |
| `demo_data.db` | 演示数据库 |
| `_temp_log_refactor.py` | 临时脚本（可删除） |
| `结构.txt` | 结构说明文本 |

---

## 🏗️ 架构特点

### 1. 单体可演进架构
- 不使用微服务、消息队列
- 模块边界清晰，职责分离
- 可平滑演进到分布式架构

### 2. 核心模块职责

| 模块 | 职责 |
|------|------|
| **Browser 模块** | 管理 Bit 浏览器窗口生命周期 |
| **Task 模块** | 定义、执行、暂停、恢复任务 |
| **Scheduler** | 任务调度与并发控制 |
| **Human 模块** | 人工介入与接管 |
| **API 层** | 对外 HTTP 接口 |
| **数据层** | 状态与日志持久化 |

### 3. 配置管理
- **唯一入口**：`app/core/settings.py`
- **配置文件**：`settings/settings.json`
- **读取方式**：`Settings.get("bit_browser.api_base")`
- **特点**：只读、单例、支持 UTF-8 BOM

### 4. 日志系统
- **类名**：`TaskLogger`（`app/core/logger.py`）
- **特点**：支持结构化日志（字典格式）
- **输出**：控制台 + 文件（`data/logs/`）
- **格式**：`[worker][action] msg`

### 5. 任务系统
- **基类**：`BaseTask`（抽象）
- **核心任务**：`task_1500.py`（1500 注册任务）
- **特点**：
  - 无 UI 依赖
  - 线程安全（每个 worker 独立 SmsClient）
  - 路径使用绝对路径（从 Settings 读取）
  - 支持多线程并发

---

## 📝 使用说明

### 1. 启动任务（控制台）
```bash
python run_console.py
```

### 2. 配置修改
编辑 `settings/settings.json`，修改：
- Bit Browser API 地址
- 火狐狸短信平台 Token
- 资源文件路径

### 3. 查看日志
```bash
# 实时日志
tail -f data/logs/task_1500_*.log

# 查看最新日志
ls -lt data/logs/ | head
```

### 4. 查看报表
打开 `data/records/` 目录下的 Excel 文件。

---

## 🔧 技术栈

- **语言**：Python 3.12
- **Web 框架**：FastAPI（预留）
- **浏览器自动化**：Playwright
- **浏览器管理**：Bit Browser Local API
- **短信平台**：火狐狸短信平台
- **数据库**：SQLite
- **报表生成**：openpyxl
- **并发**：ThreadPoolExecutor

---

## 📌 注意事项

1. **资源文件**：确保 `resources/` 目录下有足够的头像和认证图片
2. **配置文件**：首次运行前必须配置 `settings.json` 中的 Token
3. **浏览器**：需要安装并启动 Bit Browser
4. **并发控制**：每启动一个线程等待 10 秒，避免触发反爬
5. **临时文件**：`temp_uploads/` 目录会自动清理，无需手动管理

---

## 🚀 后续扩展方向

1. **Web UI**：开发 `web/` 目录下的前端界面
2. **API 完善**：完善 `app/api/` 下的 REST API
3. **任务扩展**：在 `app/services/tasks/` 添加新任务类型
4. **监控系统**：实时任务状态监控
5. **分布式**：调度器独立进程、Redis 状态存储

---

**文档生成时间**：2026-02-09  
**项目状态**：开发中  
**架构模式**：单体可演进架构
